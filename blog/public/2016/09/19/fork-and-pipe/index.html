<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> pipe and fork · 4fun</title><meta name="description" content="pipe and fork - wangke"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="4fun"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/wangke1020" target="_blank" class="nav-list-link">GITHUB</a></li></ul></header><section class="container"><head></head><div class="post"><article class="post-block"><h1 class="post-title">pipe and fork</h1><div class="post-info">2016年9月19日</div><div class="post-content"><h2 id="Pipe-Introduction"><a href="#Pipe-Introduction" class="headerlink" title="Pipe Introduction"></a>Pipe Introduction</h2><p>Every program we run on the command line automatically has three data streams connected to it.</p>
<p>STDIN (0) - Standard input (data fed into the program)<br>STDOUT (1) - Standard output (data printed by the program, defaults to the terminal)<br>STDERR (2) - Standard error (for error messages, also defaults to the terminal)</p>
<p><img src="/image/pipe_and_fork/streams.png" alt="streams"></p>
<h2 id="Create-a-simple-pipe-in-C"><a href="#Create-a-simple-pipe-in-C" class="headerlink" title="Create a simple pipe in C"></a>Create a simple pipe in C</h2><p>To create a simple pipe with C, we make use of the pipe() system call. It takes a single argument, which is an array of two integers, and if successful, the array will contain two new file descriptors to be used for the pipeline. After creating a pipe, the process typically spawns a new process (remember the child inherits open file descriptors).</p>
<blockquote>
<p>SYSTEM CALL: pipe();                                                          </p>
<p>  PROTOTYPE: int pipe( int fd[2] );<br>    RETURNS: 0 on success<br>             -1 on error: errno = EMFILE (no free descriptors)<br>                                  EMFILE (system file table is full)<br>                                  EFAULT (fd array is not valid)                </p>
</blockquote>
<p>NOTES: fd[0] is set up for reading, fd[1] is set up for writing</p>
<p>code example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;sys/types.h&gt;</div><div class="line"></div><div class="line">main()</div><div class="line">&#123;</div><div class="line">    int     fd[2];</div><div class="line">    pid_t   childpid;</div><div class="line"></div><div class="line">    pipe(fd);</div><div class="line">    .</div><div class="line">    .</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>After pipe is invoked, fd[0] and fd[1] are connected as following picture.</p>
<p><img src="/image/pipe_and_fork/pipe.png" alt="pipe"></p>
<a id="more"></a>
<h3 id="Use-fork-and-pipe"><a href="#Use-fork-and-pipe" class="headerlink" title="Use fork and pipe"></a>Use fork and pipe</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;sys/types.h&gt;</div><div class="line"></div><div class="line">main()</div><div class="line">&#123;</div><div class="line">        int     fd[2];</div><div class="line">        pid_t   childpid;</div><div class="line"></div><div class="line">        pipe(fd);</div><div class="line"></div><div class="line">        if((childpid = fork()) == -1)</div><div class="line">        &#123;</div><div class="line">                perror(&quot;fork&quot;);</div><div class="line">                exit(1);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if(childpid == 0)</div><div class="line">        &#123;</div><div class="line">                /* Child process closes up input side of pipe */</div><div class="line">                close(fd[0]);</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">                /* Parent process closes up output side of pipe */</div><div class="line">                close(fd[1]);</div><div class="line">        &#125;</div><div class="line">        .</div><div class="line">        .</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>After fork is called, child process is created and it also have the two file descriptors.</p>
<p><img src="/image/pipe_and_fork/pipe_and_fork.png" alt="pipe_and_fork"></p>
<p>If the parent wants to receive data from the child, it should close fd1, and the child should close fd0. If the parent wants to send data to the child, it should close fd0, and the child should close fd1. Since descriptors are shared between the parent and child, we should always be sure to close the end of pipe we aren’t concerned with. On a technical note, the EOF will never be returned if the unnecessary ends of the pipe are not explicitly closed.</p>
<p><img src="/image/pipe_and_fork/after_close_unused_ends.png" alt="pipe_and_fork"></p>
<p> Once the pipeline has been established, the file descriptors may be treated like descriptors to normal files.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">/*****************************************************************************</div><div class="line"> Excerpt from &quot;Linux Programmer&apos;s Guide - Chapter 6&quot;</div><div class="line"> (C)opyright 1994-1995, Scott Burkett</div><div class="line"> *****************************************************************************</div><div class="line"> MODULE: pipe.c</div><div class="line"> *****************************************************************************/</div><div class="line"></div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;sys/types.h&gt;</div><div class="line"></div><div class="line">int main(void)</div><div class="line">&#123;</div><div class="line">        int     fd[2], nbytes;</div><div class="line">        pid_t   childpid;</div><div class="line">        char    string[] = &quot;Hello, world!\n&quot;;</div><div class="line">        char    readbuffer[80];</div><div class="line"></div><div class="line">        pipe(fd);</div><div class="line"></div><div class="line">        if((childpid = fork()) == -1)</div><div class="line">        &#123;</div><div class="line">                perror(&quot;fork&quot;);</div><div class="line">                exit(1);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if(childpid == 0)</div><div class="line">        &#123;</div><div class="line">                /* Child process closes up input side of pipe */</div><div class="line">                close(fd[0]);</div><div class="line"></div><div class="line">                /* Send &quot;string&quot; through the output side of pipe */</div><div class="line">                write(fd[1], string, (strlen(string)+1));</div><div class="line">                exit(0);</div><div class="line">        &#125;</div><div class="line">        else</div><div class="line">        &#123;</div><div class="line">                /* Parent process closes up output side of pipe */</div><div class="line">                close(fd[1]);</div><div class="line"></div><div class="line">                /* Read in a string from the pipe */</div><div class="line">                nbytes = read(fd[0], readbuffer, sizeof(readbuffer));</div><div class="line">                printf(&quot;Received string: %s&quot;, readbuffer);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return(0);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference:"></a>Reference:</h3><ul>
<li><a href="http://tldp.org/LDP/lpg/node11.html" target="_blank" rel="external">http://tldp.org/LDP/lpg/node11.html</a></li>
<li><a href="https://upsilon.cc/~zack/teaching/1314/progsyst/cours-03-pipe.pdf" target="_blank" rel="external">https://upsilon.cc/~zack/teaching/1314/progsyst/cours-03-pipe.pdf</a></li>
</ul>
</div></article></div></section><footer><div class="paginator"><a href="/2016/10/26/Gossip-Protocal/" class="prev">PREV</a></div><div class="copyright"><p>© 2015 - 2016 <a href="http://yoursite.com">wangke</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script type="text/x-mathjax-config">MathJax.Hub.Config({
   tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
   });</script><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>